<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>DeepSeek Coder Flask App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container" id="inputArea">
        <textarea id="userInput" placeholder="Type your query and press Enter"></textarea>
        <div id="messageContainer">
            <!-- Messages will be prepended here -->
        </div>
    </div>
    <div class="container" id="outputArea">
        <!-- Response will be displayed here -->
    </div>
    <script>
        const inputArea = document.getElementById('userInput');

        // Function to handle and format user input messages, including code blocks
    function formatMessage(message) {
        // Locate the first and last occurrence of triple backticks
        const firstTickIndex = message.indexOf('```');
        const lastTickIndex = message.lastIndexOf('```');

        let messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';  // Assign the message bubble class

        if (firstTickIndex !== -1 && lastTickIndex !== -1 && firstTickIndex !== lastTickIndex) {
            // Extract everything before, within, and after the code block
            let beforeCode = message.substring(0, firstTickIndex);
            let codeContent = message.substring(firstTickIndex + 3, lastTickIndex);
            let afterCode = message.substring(lastTickIndex + 3);

            // Assemble the content with proper formatting
            let contentHTML = `
            ${beforeCode}
            <div class="code-block">
                <span class="code-label">Code</span>
                <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                <pre><code>${codeContent}</code></pre>
            </div>
            ${afterCode}
        `;
            messageBubble.innerHTML = contentHTML;  // Set the entire content as HTML of the message bubble
        } else {
            // If no valid code block is found, treat the whole message as normal text
            messageBubble.innerHTML = message;
        }

        return messageBubble;  // Return the fully prepared message bubble DOM element
    }


    function formatApiResponse(text) {
        // Handle Markdown formatting for bold and headers
        text = text.replace(/### (.+?)(\n|$)/g, '<h3>$1</h3>')
            .replace(/## (.+?)(\n|$)/g, '<h2>$1</h2>')
            .replace(/# (.+?)(\n|$)/g, '<h1>$1</h1>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        // Handle LaTeX-style math notations
        text = text.replace(/\\\[(.*?)\\\]/g, '<div class="math-equation">$1</div>')
            .replace(/\\\((.*?)\\\)/g, '<span class="math-equation-inline">$1</span>');

        // Preserve line breaks by converting them to <br>
        text = text.replace(/\n/g, '<br>');

        // Handle code blocks separately to avoid escaping issues inside them
        let formattedText = text.replace(/```([\s\S]+?)```/g, (match, code) => {
            // Unescape HTML special characters inside code blocks for accurate display
            let unescapedCode = code.replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"').replace(/&#039;/g, "'");
            return `<div class="code-block">
                    <span class="code-label">Code</span>
                    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    <pre><code>${unescapedCode}</code></pre>
                </div>`;
        });

        // Wrap the entire formatted text in a response-bubble for styling
        return `<div class="response-bubble">${formattedText}</div>`;
    }


        function copyToClipboard(btn) {
            const codeText = btn.parentNode.querySelector('pre code').textContent;
            navigator.clipboard.writeText(codeText).then(() => {
                btn.textContent = 'Copied!';
                setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
            }).catch(err => {
                console.error('Error copying text: ', err);
                btn.textContent = 'Failed to copy';
            });
        }

        inputArea.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent default form submission
                const userInput = this.value.trim();
                if (userInput) {
                    const messageBubble = formatMessage(userInput);
                    document.getElementById('messageContainer').prepend(messageBubble);
                    fetch('/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_input: userInput })
                    })
                        .then(response => response.json())
                        .then(data => {
                            const outputArea = document.getElementById('outputArea');
                            const newOutput = formatApiResponse(data.content || "No response content");
                            outputArea.insertAdjacentHTML('afterbegin', newOutput);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            document.getElementById('outputArea').textContent = "Error fetching response";
                        });
                    this.value = '';  // Clear the input field after sending
                }
            }
        });
    </script>



</body>

</html>